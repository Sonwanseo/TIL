# Chapter 11. 웹 소켓으로 실시간 데이터 전송하기

## 11.1 웹 소켓 이해하기

웹 소켓은 실시간 양방향 데이터 전송을 위한 기술입니다.
HTTP와 다르게 WS라는 프로토콜을 사용합니다.
따라서 브라우저와 서버가 WS 프로토콜을 지원하면 사용할 수 있습니다.

웹 소켓이 나오기 이전에는 HTTP 기술을 사용하여 실시간 데이터 전송을 구현했습니다.
그중 한 가지가 폴링이라고 불리는 방식입니다.
HTTP가 클라이언트에서 서버로 향하는 단방향 통신이므로 주기적으로 서버에 새로운 업데이트가 없는지 확인하는 요청을 보내, 있다면 새로운 내용을 가져오는 단순무식한 방법이었습니다.

처음에 웹 소켓 연결이 이루어지고 나면 그 다음부터는 계속 연결된 상태로 있어 따로 업데이트가 있는지 요청을 보낼 필요가 없습니다.

서버센트 이벤트라는 기술도 등장했습니다.
EventSource라는 객체를 사용하는데, 처음에 한 번만 연결하면 서버가 클라이언트에 지속적으로 데이터를 보내줍니다.
웹 소켓과 다른 점은 클라이언트로 데이터를 보내는 단방향 통신입니다.

Socket.IO는 웹 소켓을 편리하게 사용할 수 있게 도와주는 라이브러리입니다.
IE9와 같이 웹 소켓을 지원하지 않는 브라우저에서는 웹 소켓 대신 폴링 방식을 사용하여 실시간 데이터 전송을 가능하게 합니다.
클라이언트 측에서 웹 소켓 연결이 끊겼다면 자동으로 재연결을 시도하기도 하고, 채팅방을 쉽게 구현할 수 있도록 메서드들이 준비되어 있습니다.

## 11.2 ws 모듈로 웹 소켓 사용하기

웹 소켓은 이벤트 기반으로 작동한다고 생각하면 됩니다.
실시간으로 데이터를 전달받으므로 항상 대기하고 있어야 합니다.
req.headers['x-forwarded-for'] || req.connection.remoteAddress)는 클라이언트의 IP를 알아내는 유명한 방법 중 하나이므로 알아두는 게 좋습니다.
익스프레스에서는 IP를 확인할 때, proxy-addr 패키지를 사용하므로 이 패키지를 사용해도 괜찮습니다.
크롬에서는 로컬 호스트로 접속한 경우, IP가 ::1로 뜹니다.
다른 브라우저에서는 ::! 외의 다른 IP가 뜰 수 있습니다.

익스프레스 서버와 연결한 후, 웹 소켓 객체(ws)에 이벤트 리스너 세 개, 즉 message, error, close를 연결해주었습니다.
message는 클라이언트로부터 메시지가 왔을 때 발생하고, error는 웹 소켓 연결 중 문제가 생겼을 때 발생합니다.
close 이벤트는 클라이언트와 연결이 끊겼을 때 발생합니다.

웹 소켓에는 네 가지 상태가 있습니다.
CONNECTING(연결중), OPEN(열림), CLOSING(닫는 중), CLOSED(닫힘)입니다.

웹 소켓은 단순히 서버에서 설정한다고 작동하는 것이 아닙니다.
클라이언트에서도 웹 소켓을 사용해야 합니다.

클라이언트에서도 역시 이벤트 기반으로 동작합니다.

## 11.3 Socket.IO 사용하기

ws 패키지는 간단하게 웹 소켓을 사용하고자 할 때 좋습니다.
구현하고자 하는 서비스가 조금 더 복잡해진다면 Socket.IO를 사용하는 것이 편합니다.
Socket.IO에 편의 기능이 많이 추가되어 있습니다.

먼저 socket.io 패키지를 불러와서 익스프레스 서버와 연결합니다.
두 번째 인자로 옵션 객체를 넣어 서버에 관한 여러 가지 설정을 할 수 있습니다.

연결 후에는 이벤트 리스너를 붙여줍니다.
connection 이벤트는 클라이언트가 접속했을 때 발생하고, 콜백으로 소켓 객체(socket)를 제공합니다.

socket.request 속성으로 요청 객체에 접근할 수 있습니다.
socket.request.res로는 응답 객체에 접근할 수 있습니다.
socket.id로 소켓 고유의 아이디를 가져올 수 있습니다.
이 아이디로 소켓의 주인이 누군지 특정할 수 있습니다.

disconnect는 클라이언트가 연결을 끊었을 때 발생하고, error는 통신 과정 중 에러가 나왔을 때 발생합니다.
reply는 사용자가 직접 만든 이벤트입니다.
클라이언트에서 reply라는 이벤트명으로 데이터를 보낼 때 서버에서 받는 부분입니다.

emit 메서드로 3초마다 클라이언트 한 명에게 메시지를 보내는 부분이 있는데, 인자가 두 개입니다.
첫 번째 인자는 이벤트 이름, 두 번째 인자는 데이터입니다.

클라이언트가 이 메시지를 받기 위해서는 news 이벤트 리스너를 만들어두어야 합니다.

Socket.IO는 먼저 폴링 방식으로 서버와 연결합니다.
그렇기 때문에 코드에서 HTTP 프로토콜을 사용한 것입니다.
폴링 연결 후, 웹 소켓
을 사용할 수 있다면 웹 소켓으로 업그레이드합니다.

## 11.4 실시간 GIF 채팅방 만들기

color-hash 모듈은 랜덤 색상을 구현해주는 모듈입니다.

주소 뒤에 /room이 붙는 것을 네임스페이스라고 부릅니다.
서버에서 /roo 네임스페이스로 보낸 데이터만 받을 수 있습니다.

서버에서 웹 소켓으로 해당 이벤트를 발생시키면 이벤트 리스너의 콜백 함수가 실행됩니다.

스크립트 부분이 크게 socket.io 연결 부분, socket.io 이벤트 리스너, 폼 전송 부분으로 구분됩니다.

join과 exit는 각각 사용자 입장과 퇴장에 관한 데이터가 웹 소켓으로 전송될 때 호출됩니다.
