# Chapter 13. 구글 API로 장소 검색 서비스 만들기

## 13.1 프로젝트 구조 갖추기

프런트엔드 측에서는 Google Maps API를 사용해 장소를 표시하고, 백엔드 측에서는 Google Places API를 사용해 장소를 검색합니다.
검색을 통해 위치를 파악하여 위치 데이터를 프런트엔드로 내려보내는 것이 주요 목표입니다.

이번 프로젝트에서는 검색했던 내역과 즐겨찾기에 추가한 장소를 데이터베이스에 저장할 것입니다.
딱히 관계형 데이터베이스가 필요하지 않으므로 NoSQL 데이터베이스인 몽고디비와 몽고디비 ODM인 몽구스를 사용할 것입니다.

즐겨찾기 스키마는 장소 아이디, 장소명, 좌표, 생성시간으로 구성되어 있습니다.
location 필드는 좌표를 지정하는 필드로, 경도와 위도 정보가 배열로 들어갑니다.
index가 2dsphere로 되어 있는데, 위치 정보를 저장하겠다는 의미입니다.

검색 내역 스키마는 검색어와 생성 시간 스키마로 구성되어 있습니다.

## 13.2 Google Places API 사용하기

Google Places API를 사용하면 구글 지도와 구글 플러스가 사용하는 장소 데이터베이스에서 데이터를 가져올 수 있습니다.

구글은 노드를 위한 API 모듈을 따로 제공합니다.

핵심 로직이 담긴 라우터는 세 개의 라우터로 이루어져 있습니다.
메인화면을 보여주는 라우터, 검색어 자동완성 라우터, 장소 검색 라우터로 구성됩니다.

구글 지도 클라이언트는 콜백 방식으로 동작하는데, 몽구스 프로미스와 같이 사용하기 위해 프로미스 패턴으로 바꾸어주었습니다.
이렇게 바꿀 수 있는 콜백들은 프로미스로 바꿔서 최종적으로 async/awit 문법을 사용하는 것이 깔끔합니다.

검색창에는 keyup 이벤트가 붙어 있으므로 검색어 입력 시 자동 완성 요청을 서버로 전달합니다.
결과로 받은 예상 검색어들을 화면에 표시하고 눌렀을 때 검색할 수 있도록 하였습니다.

검색폼에는 submit 이벤트가 붙어 있습니다.
검색어를 입력하지 않았다면 폼 요청을 하지 않습니다.
검색어를 입력한 경우에는 폼 요청 주소(this.action)를 노드 라우터에 맞게 설정한 후, 폼 요청을 전송합니다.

## 13.3 Google Maps API 사용하기

Google Maps API는 클라이언트 API입니다.

## 13.4 위치 기반 검색 수행하기

Google Places API가 그리 정확한 결과를 반환하지는 않습니다.
정확도를 높이기 위해 내 위치 주변을 검색하는 API와 특정 종류의 장소(카페, 병원 등)만 검색하는 API를 추가로 만들어보겠습니다.

쿼리스트링으로 lat과 lng이 제공되면 places API 대신에 placesNearby API를 사용합니다.
이 API의 옵션으로는 keyword, rankby, langauge, radius 등이 있습니다.
keyword는 찾을 검색어, location 위도와 경도, rankby는 정렬 순서, language는 검색 언어를 의미합니다.
radius는 인기순으로 정렬하고 싶을 때 검색 반경을 입력하는 용도로 사용됩니다.

검색 결과를 좀 더 정확하게 만들고 싶다면 아예 장소의 종류까지 지정해주면 됩니다.
places와 placesNear API의 옵션으로 type을 줄 수 있습니다.

new google.maps.InfoWindow(옵션)이 정보창을 띄우는 코드입니다.
옵션으로는 content가 있는데, 여기에 정보창 내용물을 넣어주면 됩니다.

정보창 내용물로는 h1 태그와 button 태그를 넣어주었습니다.
h1 태그에는 장소명을, button 태그에는 즐겨찾기 추가라는 텍스트를 표시하게 했고, 버튼을 눌렀을 경우 즐겨찾기 추가 라우터에 POST 요청을 보내도록 하였습니다.

즐겨찾기 추가를 위한 POST /location/:id/favorite 라우터도 추가하였습니다.
Favorite 스키마에 다큐먼트를 추가하는데, 장소를 넣을 때 경도, 위도순으로 넣어야 한다는 것에 주의하세요.
Google Maps API를 사용할 때와 순서가 반대입니다.
