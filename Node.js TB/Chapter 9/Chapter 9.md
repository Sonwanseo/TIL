# Chapter 9. 익스프레스로 SNS 서비스 만들기

## 9.1 프로젝트 구조 갖추기

서버 코드를 수정하면 nodemon이 서버를 자동으로 재시작 해줍니다.
nodemon이 실행되는 콘솔에 rs를 입력해서 수동으로 재시작할 수도 있습니다.

키를 하드코딩하면 소스 코드가 유출되었을 때 키도 같이 유출되므로 별도로 관리해야 합니다.
이를 위한 패키지가 dotenv입니다.
비밀키는 .env라는 파일에 모아두고, dotenv가 .env 파일을 읽어 process.env 객체에 넣습니다.

.env 파일에 키=값 형식으로 비밀키를 추가합니다.

서버 시작 시 .env의 비밀키들을 process.env에 넣으므로 이후로 process.env.COOKIE_SECRET처럼 키를 사용할 수 있습니다.

하드코딩된 비밀번호가 유일하게 남아 있는 파일이 있습니다.
시퀄라이즈 설정을 담아둔 config.json입니다.
JSON 파일이라 process.env를 사용할 수 없습니다.

/profile, /join, /까지 페이지 세 개로 구성되어 있습니다.

main.pug에서는 user 변수가 존재할 때 게시글 업로드 폼을 보여줍니다.

profile.pug는 사용자의 팔로워와 팔로잉 중인 목록을 보여줍니다.

join.pug는 회원가입하는 폼을 보여줍니다.

error.pug는 서버에 에러 발생 시 에러 내역을 보여줍니다.

## 9.2 데이터베이스 세팅하기

로그인 기능이 있으므로 사용자 테이블이 필요하고, 게시글을 저장할 게시글 테이블도 필요합니다.
해시태그를 사용하므로 해시태그 테이블도 만들어야 합니다.

이메일, 닉네임, 비밀번호를 저장하고, SNS 로그인을 하엿을 경우에는 provider와 snsId를 저장합니다.
provider가 local이면 로컬 로그인을 한 것이고, kakao면 카카오 로그인을 한 것입니다.

게시글 모델은 게시글 내용과 이미지 경로를 저장합니다.

해시태그 모델은 태그 이름을 저장합니다.

같은 테이블 간 N:M 관계에서는 모델 이름과 컬럼 이름을 따로 정해주어야 합니다.

as 옵션은 시퀄라이즈가 JOIN 작업 시 사용하는 이름입니다.

## 9.3 Passport 모듈로 로그인 구현하기

회원가입과 로그인은 직접 구현할 수도 있지만, 복잡한 작업이 많으므로 검증된 모듈을 사용하는 것이 좋습니다.
바로 Passport를 사용하는 것입니다.

요즘에는 서비스에 로그인을 할 때 아이디와 비밀번호를 입력해서 하지 않고 기존의 SNS 서비스 계정으로 로그인하기도 합니다.
이 또한 Passport를 사용해서 해결할 수 있습니다.

폴더 내의 index.js 파일은 require 시 이름을 생략할 수 있습니다.

passport.initialize() 미들웨어는 요청(req 객체)에 passport 설정을 심고, passport.session() 미들웨어는 req.session 객체에 passport 정보를 저장합니다.
req.session 객체는 express-session에서 생성하는 것이므로 passport 미들웨어는 express-session 미들웨어보다 뒤에 연결해야 합니다.

serializeUser는 req.session 객체에 어떤 데이터를 저장할지 선택합니다.
매개변수로 user를 받아, done 함수에 두 번째 인자로 user.id를 넘기고 있습니다.
done 함수의 첫 번째 인자는 에러 발생 시 사용하는 것이므로 두 번째 인자가 중요합니다.

deserializeUser는 매 요청 시 실행됩니다.
passport.session() 미들웨어가 이 메서드를 호출합니다.
serializeUser에서 세션에 저장했던 아이디를 받아 데이터베이스에서 사용자 정보를 조회합니다.
조회한 정보를 req.user에 저장하므로 앞으로 req.user를 통해 로그인한 사용자의 정보를 가져올 수 잇습니다.

serializeUser는 사용자 정보 객체를 세션에 아이디로 저장하는 것이고, deserializeUser는 세션에 저장한 아이디를 통해 사용자 정보 객체를 불러오는 것입니다.

localStrategy와 kakaoStrategy 파일은 각각 로컬 로그인과 카카오 로그인 전략에 대한 파일입니다.
Passport는 로그인 시의 동작을 전략이라는 용어로 표현하고 있습니다.

### 9.3.1 로컬 로그인 궇녀하기

로컬 로그인이란 다른 SNS 서비스를 통해 로그인하지 않고, 자체적으로 회원가입 후 로그인하는 것을 의미합니다.
Passport에서 이를 구현하려면 passport-local 모듈이 필요합니다.

로그인한 사용자는 회원가입과 로그인 라우터에 접근하면 안 됩니다.
마찬가지로 로그인하지 않은 사용자는 로그아웃 라우터에 접근하면 안됩니다.
따라서 라우터에 접근 권한을 제어하는 미들웨어가 필요합니다.
미들웨어를 만들며 Passport가 req 객체에 추가해주는 isAuthenticated 메서드를 알아봅시다.

Passport는 req 객체에 isAuthenticated 메서드를 추가합니다.
로그인 중이면 req.isAuthenticated()가 true고, 아니면 false 입니다.

사용자 데이터베이스에서 일치하는 이메일이 있는지 찾은 후, 있다면 bcrypt의 compare 함수로 비밀번호를 비교합니다.
비밀번호까지 일치했다면 done 함수의 두 번째 인자로 사용자 정보를 넣어 보냅니다.
두 번째 인자를 사용하지 않는 경우는 로그인에 실패했을 때뿐입니다.
done 함수의 첫 번째 인자를 사용하는 경우는 서버쪽에서 에러가 발생하였을 때고, 세 번째 인자를 사용하는 경우는 로그인 처리 과정에서 비밀번호가 일치하지 않거나 존재하지 않는 회원일 때와 같은 사용자 정의 에러가 발생하였을때입니다.

done이 호출된 후에는 다시 passport.authenticate의 콜백 함수에서 나머지 로직이 실행됩니다.
