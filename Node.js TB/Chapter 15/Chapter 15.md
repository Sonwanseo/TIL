# Chapter 15. AWS와 GCP로 배포하기

## 15.1 서비스 운영을 위한 패키지

### 15.1.1 morgan과 express-session

process.env.NODE_ENV는 배포 환경인지 개발 환경인지를 판단할 수 있는 환경 변수입니다.
배포 환경일 때는 morgan을 combined 모드로 사용하고, 개발 환경일 때는 dev 모드로 사용합니다.
combined 모드는 dev 모드에 비해 더 많은 사용자 정보를 로그로 남깁니다.

참고로 proceess.env.NODE_ENV는 .env에 넣을 수 없습니다.
개발 환경인지 배포 환경인지에 따라 값이 변해야 하는데, .env 파일은 정적 파일이기 때문입니다.

express-session은 배포 환경일 때는 proxy를 true로, cookie-secure를 true로 바꿉니다.
proxy를 tru로 적용해야 하는 경우는 https 적용을 위해 노드 서버 앞에 다른 서버를 두었을 때입니다.
cookie.secure 또한 https 적용이나 로드밸런싱(요청 부하 분산) 등을 위해 true로 바꿔줍니다.

### 15.1.2 sequelize

시퀄라이즈에서 가장 큰 문제는 비밀번호가 하드코딩되어 있다는 것입니다.
JSON 파일이므로 변수를 사용할 수 없습니다.
다행히 시퀄라이즈는 JSON 대신 JS 파일을 설정 파일로 쓸 수 있게 지원합니다.

JS 파일이므로 dotenv 모듈을 사용할 수 있습니다.
root 계정은 숨기는 게 좋습니다.

process.env가 development일 때는 development 속성의 설정 내용이 적용되고, production일 때는 production 속성의 설정 내용이 적용됩니다.

배포 환경에서는 어떤 쿼리가 수행되는지 숨기는 것이 좋습니다.
따라서 production일 경우에는 logging에 false를 주어 쿼리 명령어를 숨겼습니다.

데이터베이스 비밀번호는 .env 파일에 입력합니다.

### 15.1.3 cross-env

cross-env 패키지를 사용하면 동적으로 process.env를 변경할 수 있습니다.

npm 스크립트를 두 개로 나누었습니다.
npm start는 배포 환경에서 사용하는 스크립트고, npm run dev는 개발 환경에서 사용하는 스크립트입니다.

### 15.1.4 retire

설치된 패키지에 문제는 없는지 확인해 보아야 합니다.
이를 위해 retire라는 패키지가 있습니다.

### 15.1.5 pm2

pm2는 원활한 서버 운영을 위한 패키지입니다.
가장 큰 기능은 서버가 에러로 인해 꺼졌을 때 서버를 다시 켜주는 것입니다.

또 하나 중요한 기능은 바로 멀티 프로세싱입니다.
멀티 스레딩은 아니지만 멀티 프로세싱을 지원하여 노드 프로세스 개수를 1개 이상으로 늘릴 수 있습니다.
CPU 코어를 하나만 사용하여 다른 코어들이 노는 일을 방지할 수 있습니다.
노드는 클라이언트로부터 요청이 왔을 때 요청을 여러 노드 프로세스에 고르게 분배합니다.
하나의 프로세스가 받는 부하가 적어지므로 서비스를 더 원활하게 운영할 수 있습니다.

멀티 스레딩이 아니므로 서버의 메모리 같은 자원을 공유하지는 못합니다.
지금까지 세션을 메모리에 저장했는데, 메모리를 공유하지 못해서 프로세스 간에 세션이 공유되지 않는 것입니다.

이 문제를 극복하기 위해서는 세션을 공유할 수 잇게 해주는 무언가가 필요합니다.
이를 위해서 주로 Memcached나 레디스 같은 서비스를 사용합니다.

pm2를 실행했더니 다른 점이 있습니다.
node나 nodemon 명령어와는 다르게 노드 프로세스가 실행되면서 콘솔에 다른 명령어를 입력할 수 있습니다.
pm2가 노드 프로세스를 백그라운드로 돌리기 때문에 가능합니다.

백그라운드에서 돌고 있는 노드 프로세스를 확인할 방법이 필요한데, pm2 list 명령어를 사용하면 됩니다.

pm2 start를 실행했을 때처럼 현재 프로세스 정보가 표시됩니다.
CPU와 메모리 사용량 등이 보여 편리합니다.

pm2 프로세스를 종료하고 싶다면 콘솔에 pm2 kill을 입력하면 됩니다.
서버를 재시작하고 시다면 pm2 reload all을 입력합니다.
다운타임(서버가 중지되어 클라이언트가 접속할 수 없는 시간)이 거의 없어 서버가 재시작되어 좋습니다.

노드의 cluster 모듈처럼 클러스터링을 가능하게 하는 pm2의 클러스터링 모드를 사용해봅시다.

pm2 start app.js 대신에 pm2 start app.js -i 0 명령어를 사용합니다.
-i 뒤에 생성하길 원하는 프로세스 개수를 기입하면 됩니다.
0은 현재 CPU 코어 개수만큼 프로세스를 생성한다는 뜻이고, -1은 프로세스를 CPU 코어 개수보다 한 개 덜 생성하겠다는 뜻입니다.
남은 코어 하나는 노드 외의 다른 작업을 할 수 있게 하기 위해서입니다.

현재 프로세스를 모니터링할 수도 있습니다.
pm2 monit으로 가능합니다.
